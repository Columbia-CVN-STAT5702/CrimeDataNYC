---
title: "Plot Ideas for Meteorological and Lunar Relationships"
author: "Rich Lavery"
date: "April 21, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache = TRUE)
```


### Read In Dataset from .csv file and merge datasets on weather and lunar cycles

```{r, message = FALSE, fig.width = 10, fig.height = 8}
#Note the "NYPD_Complaint_Data_Historic.csv" should be in the working directory when running this file.
#Note the "nyc_weather_data.csv" file should be in the working directory when running this file.
#Note the "nyc_moon_data.csv" file should be in the working directory when running this file.

library(dplyr)
library(tidyr)
library(ggplot2)
library(vcdExtra)
library(data.table)

########################################################################################
var_names <- c("Id", "DateStart", "TimeStart", "DateEnd", "TimeEnd", "DateReport", "ClassCode", "OffenseDesc", 
               "IntClassCode", "IntOffenseDesc", "AtptCptdStatus", "Level", "Jurisdiction", "Boro", "Pct", "LocOfOccr", "PremDesc", 
               "ParkName", "HousingDevName", "XCoord", "YCoord", "Lat", "Long", "Lat_Long")

crime_df <- fread("NYPD_Complaint_Data_Historic.csv",na.strings="", col.names = var_names, stringsAsFactors = TRUE)

#Convert dates and times to correct format
crime_df$DateStart <- as.Date(crime_df$DateStart, format='%m/%d/%Y')
crime_df$DateEnd <- as.Date(crime_df$DateEnd, format='%m/%d/%Y')
crime_df$DateReport <- as.Date(crime_df$DateReport, format='%m/%d/%Y')

########################################################################################
#Read in weather data from file
weather_select = c("DATE", "AWND", "PRCP", "SNOW", "TMAX")
weather_data <- fread("nyc_weather_data.csv", na.strings="", select = weather_select, stringsAsFactors = FALSE)
weather_data$DATE <- as.Date(weather_data$DATE)
weather_data$AWND <- as.numeric(weather_data$AWND)
weather_data$PRCP <- as.numeric(weather_data$PRCP)
weather_data$SNOW <- as.numeric(weather_data$SNOW)
weather_data$TMAX <- as.numeric(weather_data$TMAX)

#Merge the data together
crime_df <- crime_df[weather_data, on=.(DateStart = DATE)]

###############################################################################
#Read in moon phase data
moon_data <- fread("nyc_moon_data.csv", na.strings="", select = c("date", "phase"), stringsAsFactors = FALSE)
moon_data$date <- as.Date(moon_data$date, format='%m/%d/%Y')
moon_data$phase <- as.factor(moon_data$phase)
full_moon_data <- moon_data %>% filter(phase == "Full Moon")

#Merge the moon phase data into the main data frame
crime_df <- crime_df %>% left_join(moon_data, by = c("DateStart" = "date"))

#Generate violent crime dataframe
#filter for violent crime
violent_crime_df <- crime_df %>% filter(OffenseDesc == "ASSAULT 3 & RELATED OFFENSES" | 
                                          OffenseDesc == "FELONY ASSAULT" | 
                                          OffenseDesc == "MURDER & NON-NEGL. MANSLAUGHTER" |  
                                          OffenseDesc == "RAPE" |
                                          OffenseDesc == "ROBBERY" |
                                          IntOffenseDesc == "AGGRAVATED SEXUAL ASBUSE" |
                                          IntOffenseDesc == "ASSAULT 2,1,UNCLASSIFIED" |
                                          IntOffenseDesc == "ASSAULT 3" |
                                          IntOffenseDesc == "RAPE 1" |
                                          IntOffenseDesc == "ROBBERY,OPEN AREA UNCLASSIFIED" |
                                          IntOffenseDesc == "SEXUAL ABUSE" |
                                          IntOffenseDesc == "SEXUAL ABUSE 3,2")

```

## Investigate the effects of precipitation on crime.
### How does the average number of reported crimes on days with more than 1/2 inch of precipitation compare to the average number of crimes reported on days with no precipitation?

```{r, fig.width = 10, fig.height = 8}
#Generate scatterplot of crime vs precipitiation
rain_summary_per_day <- crime_df %>% group_by(DateStart) %>% summarize(Count = n()) %>% drop_na()
#append weather data
rain_summary_per_day <- cbind(rain_summary_per_day, weather_data) %>% select(DATE, PRCP, SNOW, TMAX, Count)
#Scatter plot of daily crimes vs. precipitation level

lm1 <- lm(Count~PRCP, rain_summary_per_day)
ggplot(rain_summary_per_day, aes(x=PRCP, y=Count)) + geom_point() +
  labs(x = "Precipitation [inches]", y = "Daily Crime Incident Count", title = "Daily Crimes vs. Precipitation") +
  geom_abline(slope=lm1[["coefficients"]][["PRCP"]],intercept=lm1[["coefficients"]][["(Intercept)"]])

#Average all days with common precipitation level and plot scatterplot
avg_crime_per_precip_level <- rain_summary_per_day %>% group_by(PRCP) %>% summarize(Avg_Count = weighted.mean(Count))
lm2 <- lm(Avg_Count~PRCP, avg_crime_per_precip_level)
ggplot(avg_crime_per_precip_level, aes(x=PRCP, y=Avg_Count)) + geom_point() +
  labs(x = "Precipitation [inches]", y = "Average Daily Crime Incident Count", title = "Average Daily Crimes vs. Precipitation") +
  geom_abline(slope=lm2[["coefficients"]][["PRCP"]],intercept=lm2[["coefficients"]][["(Intercept)"]])

#Regenerate plots for only violent crimes
#Generate scatterplot of crime vs precipitiation
rain_summary_per_day <- violent_crime_df %>% group_by(DateStart) %>% summarize(Count = n()) %>% drop_na()
#append weather data
rain_summary_per_day <- cbind(rain_summary_per_day, weather_data) %>% select(DATE, PRCP, SNOW, TMAX, Count)
#Scatter plot of daily crimes vs. precipitation level

lm1 <- lm(Count~PRCP, rain_summary_per_day)
ggplot(rain_summary_per_day, aes(x=PRCP, y=Count)) + geom_point() +
  labs(x = "Precipitation [inches]", y = "Daily Crime Incident Count", title = "Daily Violent Crimes vs. Precipitation") +
  geom_abline(slope=lm1[["coefficients"]][["PRCP"]],intercept=lm1[["coefficients"]][["(Intercept)"]])

#Average all days with common precipitation level and plot scatterplot
avg_crime_per_precip_level <- rain_summary_per_day %>% group_by(PRCP) %>% summarize(Avg_Count = weighted.mean(Count))
lm2 <- lm(Avg_Count~PRCP, avg_crime_per_precip_level)
ggplot(avg_crime_per_precip_level, aes(x=PRCP, y=Avg_Count)) + geom_point() +
  labs(x = "Precipitation [inches]", y = "Average Daily Crime Incident Count", title = "Average Daily Violent Crimes vs. Precipitation") +
  geom_abline(slope=lm2[["coefficients"]][["PRCP"]],intercept=lm2[["coefficients"]][["(Intercept)"]])
```

### We can clearly see a reduction in the average number of crimes reported on days with significant precipitation.  This is not very surprising as we would expect less people to be out on days with bad weather.

## Investigate the effects of a full moon on criminal activity.
### There is an "old wives tale" about how a full moon tends to make people more erratic and violent.  This partially explains the etymology of the word "lunatic."  We are looking for evidence of this theory by merging historical data on the occurance of a full moon with our crime dataset.

```{r, fig.width = 10, fig.height = 8}
#Generate plot to compare averge number of crimes on full moon days as compared to non-full moon days
crime_summary_reg <- crime_df %>% filter(phase != "Full Moon") %>% group_by(Pct) %>% summarize(count_reg = n(), n_days_reg = n_distinct(DateStart), Avg_Reg = count_reg/n_days_reg) %>% drop_na() %>% select(Pct, Avg_Reg)
crime_summary_fm <- crime_df %>% filter(phase == "Full Moon") %>% group_by(Pct) %>% summarize(count_fm = n(), n_days_fm = n_distinct(DateStart), Avg_Fm = count_fm/n_days_fm) %>% drop_na() %>% select(Pct, Avg_Fm)
#Merge the summary tables together
fm_summary <- crime_summary_reg %>% left_join(crime_summary_fm, by = c("Pct" = "Pct"))
fm_summary$Pct <- as.factor(fm_summary$Pct)
#Tidy the summary table
tidy_fm_summary <- fm_summary %>% gather(key = "Moon Phase", value = "AvgDailyReports", -Pct)
fm_summary_diff <- fm_summary %>% mutate(Delta = Avg_Fm - Avg_Reg)

fm_summary_arr <- fm_summary_diff %>% arrange(Avg_Reg)
fm_summary_arr <- fm_summary_arr %>% mutate(Pct = factor(Pct, Pct))
ggplot(fm_summary_arr, aes(group=1)) + geom_step(aes(x=Pct, y=Avg_Reg, color="No Full Moon"), size=1) + 
  geom_step(aes(x=Pct, y=Avg_Fm, color="Full Moon"), size=1) + 
  scale_color_discrete(name = "Moon Phase") + 
  theme(axis.text.x=element_text(angle=90,hjust=1)) +
  labs(x= "Precinct", y = "Average Number of Crimes per Day")
```

### We can see from the data that crime does not appear to be affected significantly on days with a full moon.  There are times when crime incidents are higher, but also times when crime incidents are lower.  We can conclude that there is no statistical evidence to support the "old wives tale."

## How does average crime reports on the hotest days compare to the average number of crime reports on the coldest days?

```{r, fig.width = 10, fig.height = 8}
#Generate plot to compare average number of crimes on cold days as compared to hot days
hot_day_summary <- crime_df %>% filter(TMAX > 90) %>% group_by(Pct) %>% summarize(count_hot = n(), n_days_hot = n_distinct(DateStart), Hot = count_hot/n_days_hot) %>% drop_na() %>% select(Pct, Hot)
cold_day_summary <- crime_df %>% filter(TMAX < 20) %>% group_by(Pct) %>% summarize(count_cold = n(), n_days_cold = n_distinct(DateStart), Cold = count_cold/n_days_cold) %>% drop_na() %>% select(Pct, Cold)
#Merge the two summary tables together
temp_summary <- hot_day_summary  %>% left_join(cold_day_summary, by = c("Pct" = "Pct"))
temp_summary$Pct <- as.factor(temp_summary$Pct)
#Tidy the summary table
tidy_temp_summary <- temp_summary %>% gather(key = "Temp", value = "AvgDailyReports", -Pct)
temp_summary_diff <- temp_summary %>% mutate(Delta = Cold - Hot)

temp_summary_arr <- temp_summary_diff %>% arrange(Hot)
temp_summary_arr <- temp_summary_arr %>% mutate(Pct = factor(Pct, Pct))
cols <- c("Hot Days" = "red", "Cold Days" = "blue")
ggplot(temp_summary_arr, aes(group=1)) + geom_step(aes(x=Pct, y=Hot, color="Hot Days"), size=1) + 
  geom_step(aes(x=Pct, y=Cold, color="Cold Days"), size=1) + 
  scale_color_manual(name = "Temperature", values = cols) + 
  theme(axis.text.x=element_text(angle=90,hjust=1)) +
  labs(x= "Precinct", y = "Average Number of Crimes per Day")
```

### We can clearly see a marked increase in crime reports on the hotest days of the year when compared to the coldest days.  This trend appears to hold true for almost all precincts.

## How does the quantity of crime reports vary across the different precincts?

```{r, fig.width = 10, fig.height = 8}
#Plot histogram of incidents by police precinct
data_pct <- crime_df %>% group_by(Pct) %>% summarize(count = n()) %>% drop_na()
ggplot(data_pct, aes(reorder(Pct, count), count)) + geom_bar(stat = "identity") + xlab("Precint Number") + ggtitle("Incidents by Precinct") + coord_flip()
```


